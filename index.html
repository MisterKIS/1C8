<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Данные из Google Sheets</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <style>
                body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .chart-container {
            max-width: 1000px;
            margin: 0 auto;
            height: 500px;
        }
        .controls {
            margin: 20px 0;
        }
        select {
            padding: 8px;
            margin: 5px;
        }
     .buttons {
    margin: 20px 0;        /* Внешние отступы: 20px сверху и снизу, 0 слева и справа */
    text-align: center; /* например, выровнять кнопки по центру */
}
     button {
    margin: 5px;           /* Отступ 5px со всех сторон у каждой кнопки */
    padding: 10px 20px;    /* Внутренние отступы: 10px сверху/снизу, 20px слева/справа */
    background: #4285f4;   /* Синий цвет фона (Google blue) */
    color: white;          /* Белый цвет текста */
    border: none;          /* Убрать стандартную рамку кнопки */
    border-radius: 4px;    /* Скруглить углы на 4px */
    cursor: pointer;       /* Изменить курсор на "руку" при наведении */
    font-size: 14px;       /* Размер шрифта */
    transition: background 0.3s; /* Плавное изменение фона за 0.3 секунды */
}
     button:hover {
    background: #3367d6;   /* Более темный синий при наведении курсора */
}

button:active {
    background: #2a56c6;   /* Еще более темный синий при нажатии */
}
    </style>
</head>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <!-- Кнопка для загрузки -->
      <div class="buttons">
    <button onclick="loadData('oll')">Загрузить остатки</button>
    <button onclick="loadData('balance')">Загрузить расходы</button>
    <button onclick="loadData('exp')">Сводные данные</button>
      </div>
    <div id="data"></div>
    <h2>Динамика данных по месяцам</h2>
    <div class="controls">
        <label>Тип диаграммы:</label>
        <select id="chartType">
            <option value="line">Линейный график</option>
            <option value="bar">Столбчатая</option>
        </select>
        <button onclick="toggleLegend()">Показать/скрыть легенду</button>
    </div>
    
    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>
    
    <div id="dataInfo"></div>
    <div id="headers-container"></div>
    <script>
      
      async function loadData(sheetName = 'oll') {
        const container = document.getElementById('data');
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbxz8mczromb-Fa6Iq2jK9Ezm2tUYsDR2waJaUdelnturU0JNCTh4p4F_T1KPgKuvo9v/exec';
  // Добавляем параметр sheet в URL
  const urlWithParams = `${scriptUrl}?sheet=${encodeURIComponent(sheetName)}`;
   try {     
      const response = await fetch(urlWithParams);
        const data = await response.json();  // Парсим JSON
     
          
        console.log('Данные из листа', sheetName, ':', data);
        //console.log('Значения:', data.values);
        if (sheetName === 'balance') {
            
        // Получаем последние 5 строк
  const lastFiveRows = data.values;
          // Отображаем данные
  displayData(lastFiveRows);
          return;
        } 
	else if(sheetName === 'exp'){
	displeyHeaders(data);
	} else {
             const result = getColumn(data, ["Паритет", "Альфа", "Наличные"]);
            const formattedData = [result.map(item => item[0]), result.map(item => item[1])];
       
        // Создаем таблицу
        displayData(formattedData, false);
        }
} catch (error) {
                console.error('Ошибка загрузки данных:', error);
                container.innerHTML = '<p style="color: red;">Ошибка загрузки данных</p>';
            }
        }

      function displeyHeaders(data) {
	const container = document.getElementById('headers-container');
	// проверяем, есть ли данные и массив values
	if (!data || !data.values || data.values.length === 0) {
                container.innerHTML = '<p>Нет данных для отображения</p>';
                return;
            }
	// получаем первую строку как заголовки
	const headers = data.values[0];
	let startCol = 7;
	let endCol = 17;
    	const result = {
        	headers: [],
        	rows: []
    	};
	result.headers = headers.slice(startCol - 1, endCol);
	    // Получаем данные для каждой строки
    for (let i = 1; i < data.values.length; i++) {
        const row = data.values[i];
        const rowData = [];
	let hasAnyData = false;
        
        for (let j = startCol - 1; j < endCol; j++) {
            const value = j < row.length ? row[j] : '';
	    rowData.push(value);
		// Проверяем, есть ли хоть какие-то данные
        if (value && value.toString().trim() !== '') {
            hasAnyData = true;
        }
           }
        // Если в строке нет данных - прекращаем
    if (!hasAnyData) {
        break;
    }
        result.rows.push(rowData);
	}
	/*console.log(result.rows);
	// создаём html для отображения заголовков
	let html = '<h3>Заголовки:</h3>';
	html +=`<ul>`;

	result.headers.forEach(header => {
                // Пропускаем пустые ячейки
                if (header !== '') {
                    html += `<li>${header}</li>`;
                }
            });
            
            html += `</ul>`;
    	    html += `<p>Всего строк: ${result.rows.length}</p>`;
    	    html += `<pre>${JSON.stringify(result.rows, null, 2)}</pre>`;
            // Отображаем результат
            container.innerHTML = html;*/
		createChart(result);

}

function displayData(rows, includeHeader = false) {
    const container = document.getElementById('data');
    if (!rows || rows.length === 0) {
                container.innerHTML = '<p>Нет данных для отображения</p>';
                return;
            }
    const hasHeader = rows[0];
    console.log('hasHeader - ', hasHeader);
    console.log('rows - ', rows);
     const lastFiveRows = rows.slice(-5);
  
// Создаем таблицу
  let html = '<table border="1" style="border-collapse: collapse; width: 100%;">';
            // Добавляем заголовок если он есть
      if (hasHeader) {
        html += '<thead><tr>';
        hasHeader.forEach(cell => {
          html += `<th style="padding: 8px; background: #f2f2f2;">${cell}</th>`;
        });
        html += '</tr></thead>';
      }
  
  
  // Добавляем последние 5 строк
  html += '<tbody>';
  lastFiveRows.forEach(row => {
    html += '<tr>';
    row.forEach(cell => {
      html += `<td style="padding: 8px;">${cell || ''}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  
  container.innerHTML = html;
}
   
     
   function getColumn(data, colname) {
     const headers = data.values[0];
    const rows = data.values;
    const lastRowIndex = rows.length - 1;
    
    // Находим индексы запрошенных колонок
    const columnIndices = colname.map(name => 
        headers.indexOf(name)
    ).filter(index => index !== -1);
    
    // Получаем значения из заголовков и последней строки
    const result = columnIndices.map(index => [
        headers[index],                    // заголовок
        rows[lastRowIndex][index]         // значение из последней строки
    ]);
    
    return result;
   }

	// Самый простой вариант - минимум кода
// Функция создания графика
        function createChart(result) {
    const ctx = document.getElementById('myChart').getContext('2d');
	
	// УДАЛИТЬ СТАРЫЙ ГРАФИК если он уже существует
    const existingChart = Chart.getChart('myChart');
    if (existingChart) {
        existingChart.destroy();
    }
    
    // Подготавливаем данные
	const labels = result.rows.map(row => row[0]); // месяцы
	const datasets = [];

	// Проходим по всем столбцам кроме первого
	for (let i = 1; i < result.headers.length; i++) {
	  const data = result.rows.map(row => parseFloat(row[i]) || 0);
        
        datasets.push({
            label: result.headers[i],
            data: data,
            borderColor: `hsl(${i * 40}, 70%, 50%)`,
            tension: 0.1,
	    pointRadius: 4, // Размер точек на линии
            pointHoverRadius: 6, // Размер точек при наведении
        });
    }
	
	// Создаем диаграмму
	new Chart(ctx, {
        type: 'line',  // Тип графика: 'line', 'bar', 'pie' и т.д.
        data: {
            labels: labels,  // Метки по оси X
            datasets: datasets  // Наборы данных (линии)
        },
        options: {
            responsive: true, // Адаптивность под размер контейнера
            plugins: {
                legend: {
                    position: 'top'  // Положение легенды: 'top', 'bottom', 'left', 'right'
                }
            }
        }
    });
}
    </script>
  </body>
</html>
